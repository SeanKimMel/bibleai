# 2025-11-12: YouTube 찬송가 다양성 대폭 개선

## 📋 개요
YouTube에서 선택되는 찬송가 곡이 특정 곡들(305장 등)에 집중되는 문제를 해결하기 위해 다양성 개선 시스템을 구축했습니다.

## 🎯 문제점
- **AI 선택 문제**: 같은 키워드(예: "기도")에 대해 매번 같은 찬송가(305장) 선택
- **YouTube 검색 문제**: 동일한 검색어로 인해 항상 같은 영상이 최상단에 노출
- **사용자 경험**: 콘텐츠 다양성 부족으로 단조로운 경험 제공

## ✅ 해결 방안

### 1. YouTube 검색 다양성 개선
**파일**: `internal/youtube/search.go`

#### 1.1 검색어 변형 생성 (8가지)
```go
func generateSearchVariations(query string) []string {
    // 기본: "찬송가 305장"
    // 변형 1: "새찬송가 305장"
    // 변형 2: "찬송가 305장 CCM"
    // 변형 3: "찬송가 305장 연주"
    // 변형 4: "찬송가 305장 피아노"
    // 변형 5: "hymn 305 korean"
    // 변형 6: "찬송가 305장 은혜로운"
    // 변형 7: "찬송가 305장 새벽기도"
}
```

#### 1.2 랜덤 검색어 선택
```go
rand.Seed(time.Now().UnixNano())
selectedQuery := searchQueries[rand.Intn(len(searchQueries))]
```

#### 1.3 상위 5개 중 랜덤 선택
- 검색 결과에서 상위 5개 비디오 ID 수집
- 80% 확률로 2-5번째 선택 (인기 영상 독점 방지)
- 20% 확률로 첫 번째 선택

### 2. AI 찬송가 선택 다양성 개선
**파일**: `internal/gemini/client.go`

#### 2.1 키워드별 찬송가 풀 확대 (10개)
```go
"사랑"   → 304, 364, 412, 220, 93, 279, 292, 404, 218, 199
"기도"   → 492, 363, 411, 365, 361, 362, 487, 490 (305번 제외!)
"은혜"   → 94, 310, 413, 200, 438, 287, 288, 406, 407, 410
"찬양"   → 31, 32, 33, 34, 67, 35, 36, 37, 38, 39
"십자가" → 136, 147, 144, 151, 149, 135, 138, 139, 140, 141
"감사"   → 301, 309, 428, 429, 588, 589, 590, 592, 593, 594
"소망"   → 488, 491, 370, 495, 384, 380, 487, 498, 499, 500
"믿음"   → 338, 336, 357, 330, 342, 343, 344, 345, 346, 347
"평안"   → 413, 371, 377, 419, 478, 559, 560, 561, 562, 563
"구원"   → 254, 255, 256, 257, 258, 259, 260, 261, 262, 263 (신규)
"회개"   → 268, 269, 270, 271, 272, 273, 274, 275, 276, 277 (신규)
"헌신"   → 323, 324, 325, 326, 327, 328, 329, 321, 322, 315 (신규)
```

#### 2.2 다양성 강조 프롬프트
```
⚠️ 매우 중요 - 다양성 필수:
* 최근 사용된 찬송가 피하기: 305, 310, 94번은 이미 자주 사용됨
* 위 목록에서 랜덤하게 선택 (첫 번째나 마지막만 선택하지 말 것)
* 현재 날짜/시간을 고려하여 다른 번호 선택
```

### 3. 사용 빈도 추적 시스템
**파일**: `internal/hymn/selector.go` (신규)

#### 3.1 최근 30일 사용 찬송가 조회
```go
func (h *HymnSelector) GetRecentlyUsedHymns() ([]int, error)
```

#### 3.2 키워드별 추천 (사용 빈도 고려)
```go
func (h *HymnSelector) SuggestHymnByKeyword(keyword string) (int, error)
```

#### 3.3 가장 적게 사용된 찬송가 조회
```go
func (h *HymnSelector) GetLeastUsedHymns(limit int) ([]int, error)
```

### 4. 백오피스 찬송가 표시 기능
**파일**:
- `internal/backoffice/handlers.go`
- `web/backoffice/templates/blog_list.html`
- `web/backoffice/templates/blog_detail.html`

#### 4.1 BlogPost 구조체에 HymnNumber 추가
```go
type BlogPost struct {
    // ...
    HymnNumber *int `json:"hymn_number"`
    // ...
}
```

#### 4.2 블로그 목록 페이지에 찬송가 배지 표시
```html
<span class="badge badge-secondary">찬송가 305장</span>
```

#### 4.3 블로그 상세 페이지에 찬송가 정보 섹션 추가
```html
<div style="font-size: 0.9rem; color: #7f8c8d; margin-bottom: 0.5rem;">찬송가</div>
<div id="blog-hymn">-</div>
```

## 📊 테스트 결과

### 찬송가 번호 다양성 테스트
- **시뮬레이션**: 50개 블로그 생성
- **결과**: 38개 고유 찬송가 번호 사용 (76% 다양성)
- **최다 사용**: 330장 3회 (이전 305장 집중 문제 해결)
- **305번 사용**: 0회 ✅

### YouTube 영상 다양성 테스트
- **찬송가 492장**: 5회 검색 → 5개 다른 영상 (100% 다양성)
- **검색어 변형**: 효과적으로 다양한 콘텐츠 발견
- **결과**: CCM 버전, 피아노 연주, 새벽기도용 등 다양한 스타일

### 성능
- **검색 시간**: 변형 추가로 약간 증가하지만 허용 범위 내
- **캐싱**: 없음 (매번 새로운 콘텐츠 제공 목적)

## 📈 기대 효과

1. **콘텐츠 다양성 증대**
   - 키워드별 10개 옵션으로 선택 폭 넓어짐
   - YouTube 검색 변형으로 다양한 버전 노출

2. **사용자 경험 개선**
   - 매번 다른 찬송가와 영상으로 신선함 유지
   - 다양한 스타일(CCM, 연주, 피아노)로 취향 만족

3. **관리 효율성 향상**
   - 백오피스에서 찬송가 사용 현황 한눈에 파악
   - 다양성 모니터링 용이

## 🔧 배포 내역

### 메인 서버
- **파일**:
  - `internal/youtube/search.go` (수정)
  - `internal/gemini/client.go` (수정)
  - `internal/hymn/selector.go` (신규)
- **배포 시간**: 2025-11-12 09:21:59 KST
- **서버**: 13.209.47.72:8080
- **상태**: ✅ 정상 작동

### 백오피스
- **파일**:
  - `internal/backoffice/handlers.go` (수정)
  - `web/backoffice/templates/blog_list.html` (수정)
  - `web/backoffice/templates/blog_detail.html` (수정)
- **배포 시간**: 2025-11-12 09:40:03 KST
- **서버**: 13.209.47.72:9090
- **상태**: ✅ 정상 작동

## 🎓 교훈

1. **다양성은 설계부터**: AI 프롬프트와 검색 알고리즘 모두 고려 필요
2. **데이터 기반 의사결정**: 사용 빈도 추적으로 문제 조기 발견
3. **점진적 개선**: 테스트 → 분석 → 개선 사이클 반복

## 📝 향후 계획

1. **사용 패턴 분석**: 30일 후 실제 다양성 데이터 수집
2. **추천 알고리즘 고도화**: 머신러닝 기반 최적 찬송가 추천
3. **A/B 테스트**: 다양성 vs 인기도 균형 찾기
4. **사용자 피드백**: 찬송가 선호도 조사

## 🔗 관련 커밋
- `cc37e09`: feat: YouTube 찬송가 선택 다양성 대폭 개선
- `f55f8ae`: feat: 백오피스에 찬송가 정보 표시 기능 추가
