<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }} - ë°±ì˜¤í”¼ìŠ¤</title>
    {{ template "styles" . }}
</head>
<body>
    {{ template "header" . }}
    {{ template "nav" . }}

    <div class="container">
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <div>
            <h2 style="margin: 0;">ì‹ ê·œ ë¸”ë¡œê·¸ ì‘ì„±</h2>
            <p style="color: #7f8c8d; margin: 0.5rem 0 0 0;">Gemini APIë¡œ ìë™ ìƒì„±í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
        <button onclick="showAutoGenerate()" class="btn btn-success" id="btn-show-auto">ğŸ¤– ìë™ ìƒì„±</button>
    </div>

    <div id="auto-generate-section" style="display: none; margin-bottom: 2rem; padding: 1.5rem; background: #e8f5e9; border-radius: 8px;">
        <h3 style="margin-top: 0;">Gemini API ìë™ ìƒì„±</h3>
        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">í‚¤ì›Œë“œ (ì„ íƒì‚¬í•­)</label>
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="auto-keyword" placeholder="ë¹„ì›Œë‘ë©´ ëœë¤ ì„ íƒë¨ (ì˜ˆ: ì‚¬ë‘, ë¯¿ìŒ, ì†Œë§)"
                       style="flex: 1; padding: 0.5rem; border: 1px solid #81c784; border-radius: 4px;">
                <button onclick="clearKeyword()" class="btn btn-secondary" style="white-space: nowrap;">ğŸ² ëœë¤</button>
            </div>
            <small style="color: #666; display: block; margin-top: 0.25rem;">
                í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ê±°ë‚˜, ë¹„ì›Œë‘ë©´ keywords í…Œì´ë¸”ì—ì„œ ìë™ìœ¼ë¡œ ëœë¤ ì„ íƒë©ë‹ˆë‹¤
            </small>
        </div>
        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ë‚ ì§œ</label>
            <input type="date" id="auto-date"
                   style="width: 100%; padding: 0.5rem; border: 1px solid #81c784; border-radius: 4px;">
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button onclick="generateBlog()" class="btn btn-success" id="btn-generate">ğŸ¤– ìƒì„± ì‹œì‘</button>
            <button onclick="hideAutoGenerate()" class="btn btn-secondary">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="error" class="error" style="display: none;"></div>
    <div id="success" class="success" style="display: none;"></div>

    <form id="blog-form" onsubmit="return submitBlog(event)">
        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ì œëª© *</label>
            <input type="text" id="title" name="title" required
                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ìŠ¬ëŸ¬ê·¸ (URL) *</label>
            <input type="text" id="slug" name="slug" required
                   placeholder="2025-01-01-example-slug"
                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #7f8c8d;">ì˜ˆ: 2025-10-17-ì‚¬ë‘</small>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ìš”ì•½ (Excerpt)</label>
            <textarea id="excerpt" name="excerpt" rows="3"
                      style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">í‚¤ì›Œë“œ</label>
            <input type="text" id="keywords" name="keywords"
                   placeholder="í‚¤ì›Œë“œ1,í‚¤ì›Œë“œ2,í‚¤ì›Œë“œ3"
                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ë³¸ë¬¸ (Markdown) *</label>
            <textarea id="content" name="content" rows="20" required
                      style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;"></textarea>
        </div>

        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button type="submit" class="btn btn-primary">ì €ì¥ (ë¯¸ë°œí–‰)</button>
            <button type="button" onclick="window.location.href='/blogs'" class="btn btn-secondary">ì·¨ì†Œ</button>
        </div>
    </form>
</div>

<script>
    // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
    document.getElementById('auto-date').valueAsDate = new Date();

    function showAutoGenerate() {
        document.getElementById('auto-generate-section').style.display = 'block';
        document.getElementById('btn-show-auto').style.display = 'none';
    }

    function hideAutoGenerate() {
        document.getElementById('auto-generate-section').style.display = 'none';
        document.getElementById('btn-show-auto').style.display = 'inline-block';
    }

    function clearKeyword() {
        document.getElementById('auto-keyword').value = '';
        document.getElementById('auto-keyword').placeholder = 'ğŸ² ëœë¤ í‚¤ì›Œë“œê°€ ìë™ ì„ íƒë©ë‹ˆë‹¤';
    }

    async function generateBlog() {
        const keyword = document.getElementById('auto-keyword').value.trim();
        const date = document.getElementById('auto-date').value;

        // í‚¤ì›Œë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ ëœë¤ ì„ íƒ ì•ˆë‚´
        if (!keyword) {
            if (!confirm('í‚¤ì›Œë“œê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.\nkeywords í…Œì´ë¸”ì—ì„œ ëœë¤ìœ¼ë¡œ ì„ íƒí•˜ì—¬ ë¸”ë¡œê·¸ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
        }

        const btn = document.getElementById('btn-generate');
        const originalText = btn.textContent;
        btn.textContent = 'ìƒì„± ì¤‘... (30ì´ˆ ì •ë„ ì†Œìš”)';
        btn.disabled = true;

        document.getElementById('error').style.display = 'none';
        document.getElementById('success').style.display = 'none';

        try {
            const response = await fetch('/api/blogs/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ keyword: keyword || '', date: date || null })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'ë¸”ë¡œê·¸ ìƒì„± ì‹¤íŒ¨');
            }

            let message = 'ë¸”ë¡œê·¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n';
            message += 'ID: ' + result.id + '\n';
            message += 'í‚¤ì›Œë“œ: ' + result.blog.keywords + '\n';
            message += 'ì œëª©: ' + result.blog.title + '\n';

            if (result.evaluation) {
                message += 'ì´ì : ' + result.evaluation.total_score.toFixed(1) + '/10\n';
                if (result.auto_published) {
                    message += '\nâœ… í’ˆì§ˆ ê¸°ì¤€ì„ í†µê³¼í•˜ì—¬ ìë™ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!';
                } else {
                    message += '\nâ³ ë¯¸ë°œí–‰ ìƒíƒœì…ë‹ˆë‹¤. ' + result.reason;
                }
            }

            alert(message);
            window.location.href = '/blogs/' + result.id;
        } catch (error) {
            document.getElementById('error').textContent = 'ì˜¤ë¥˜: ' + error.message;
            document.getElementById('error').style.display = 'block';
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    async function submitBlog(event) {
        event.preventDefault();

        const formData = {
            title: document.getElementById('title').value,
            slug: document.getElementById('slug').value,
            content: document.getElementById('content').value,
            excerpt: document.getElementById('excerpt').value,
            keywords: document.getElementById('keywords').value
        };

        try {
            const response = await fetch('/api/blogs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'ë¸”ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨');
            }

            document.getElementById('success').textContent = 'ë¸”ë¡œê·¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
            document.getElementById('success').style.display = 'block';
            document.getElementById('error').style.display = 'none';

            setTimeout(() => {
                window.location.href = '/blogs/' + result.id;
            }, 1500);
        } catch (error) {
            document.getElementById('error').textContent = 'ì˜¤ë¥˜: ' + error.message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('success').style.display = 'none';
        }

        return false;
    }
</script>
    </div>
</body>
</html>
