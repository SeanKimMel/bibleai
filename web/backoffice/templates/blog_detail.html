<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }} - ë°±ì˜¤í”¼ìŠ¤</title>
    {{ template "styles" . }}
    <style>
        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            border-bottom: 1px solid #ecf0f1;
        }
        .score-label { color: #7f8c8d; }
        .score-value { font-weight: bold; color: #2c3e50; }
        @media (max-width: 768px) {
            .score-grid { display: block !important; }
            .score-item { padding: 0.75rem 0.5rem; }
        }
    </style>
</head>
<body>
    {{ template "header" . }}
    {{ template "nav" . }}

    <div class="container">
<div id="loading" class="loading">ë¡œë”© ì¤‘...</div>
<div id="error" class="error" style="display: none;"></div>
<div id="success" class="success" style="display: none;"></div>

<div id="blog-detail" style="display: none;">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
            <div style="flex: 1; min-width: 200px;">
                <h2 id="blog-title" style="margin: 0;"></h2>
                <p style="color: #7f8c8d; margin-top: 0.5rem; font-size: 0.9rem;">
                    <span id="blog-slug"></span> Â· ì¡°íšŒìˆ˜: <span id="blog-views"></span>
                </p>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button id="btn-publish" onclick="togglePublish()" class="btn btn-success">ë°œí–‰</button>
                <button onclick="window.location.href='/blogs'" class="btn btn-secondary">ëª©ë¡</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
            <h2 style="margin: 0;">í’ˆì§ˆ í‰ê°€</h2>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button onclick="evaluateBlog()" class="btn btn-primary btn-sm" id="btn-evaluate">ì¬í‰ê°€</button>
                <button onclick="toggleRegenerateForm()" class="btn btn-warning btn-sm" id="btn-regenerate" style="display: none;">ğŸ”„ í”¼ë“œë°± ê¸°ë°˜ ì¬ìƒì„±</button>
                <button onclick="toggleHistory()" class="btn btn-secondary btn-sm" id="btn-toggle-history">í‰ê°€ ì´ë ¥ ë³´ê¸°</button>
            </div>
        </div>

        <!-- ì¬ìƒì„± í”¼ë“œë°± ì…ë ¥ í¼ -->
        <div id="regenerate-form" style="display: none; background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <h3 style="margin-top: 0; font-size: 1rem; color: #2c3e50;">ğŸ“ ì¶”ê°€ í”¼ë“œë°± ì…ë ¥ (ì„ íƒì‚¬í•­)</h3>
            <textarea id="custom-feedback"
                      placeholder="AIì—ê²Œ ì¶”ê°€ë¡œ ìš”ì²­í•  ê°œì„ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: 'ë„ì…ë¶€ë¥¼ ë” ì§§ê²Œ í•´ì£¼ì„¸ìš”', 'ì²­ë…„ì¸µì´ ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”' ë“±"
                      style="width: 100%; min-height: 100px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"></textarea>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                <button onclick="executeRegenerate()" class="btn btn-warning btn-sm">ğŸ”„ ì¬ìƒì„± ì‹¤í–‰</button>
                <button onclick="toggleRegenerateForm()" class="btn btn-secondary btn-sm">ì·¨ì†Œ</button>
            </div>
            <p style="font-size: 0.85rem; color: #7f8c8d; margin: 0.5rem 0 0 0;">
                ğŸ’¡ íŒ: í”¼ë“œë°±ì„ ë¹„ì›Œë‘ë©´ AI í‰ê°€ ê²°ê³¼ë§Œì„ ê¸°ë°˜ìœ¼ë¡œ ì¬ìƒì„±í•©ë‹ˆë‹¤.
            </p>
        </div>

        <div id="evaluation-section">
            <div id="scores-container" style="margin: 1rem 0;">
                <div class="score-item">
                    <span class="score-label">ì‹ í•™ì  ì •í™•ì„±</span>
                    <span class="score-value" id="score-theological">-</span>
                </div>
                <div class="score-item">
                    <span class="score-label">ì½˜í…ì¸  êµ¬ì¡°</span>
                    <span class="score-value" id="score-structure">-</span>
                </div>
                <div class="score-item">
                    <span class="score-label">ë…ì ì°¸ì—¬ë„</span>
                    <span class="score-value" id="score-engagement">-</span>
                </div>
                <div class="score-item">
                    <span class="score-label">ê¸°ìˆ ì  í’ˆì§ˆ</span>
                    <span class="score-value" id="score-technical">-</span>
                </div>
                <div class="score-item">
                    <span class="score-label">SEO ìµœì í™”</span>
                    <span class="score-value" id="score-seo">-</span>
                </div>
                <div class="score-item" style="background: #f8f9fa; font-weight: bold;">
                    <span class="score-label">ì´ì </span>
                    <span class="score-value" style="font-size: 1.2rem; color: #e74c3c;" id="score-total">-</span>
                </div>
            </div>

            <div id="feedback-section" style="margin-top: 1rem;">
                <div style="font-size: 0.9rem; color: #7f8c8d; margin-bottom: 0.5rem;">í‰ê°€ í”¼ë“œë°±</div>
                <div id="quality-feedback" style="background: #f8f9fa; padding: 1rem; border-radius: 4px; white-space: pre-wrap;"></div>
            </div>

            <div style="margin-top: 1rem; color: #7f8c8d; font-size: 0.9rem;">
                í‰ê°€ì¼: <span id="evaluation-date">-</span> Â· í‰ê°€ì: <span id="evaluator">-</span>
            </div>
        </div>

        <div id="history-section" style="display: none; margin-top: 2rem; border-top: 1px solid #ecf0f1; padding-top: 1rem;">
            <h3 style="font-size: 1rem; margin-bottom: 1rem; color: #2c3e50;">í‰ê°€ ì´ë ¥</h3>
            <div id="history-list"></div>
        </div>
    </div>

    <div class="card">
        <h2>ì½˜í…ì¸ </h2>
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
            <div style="font-size: 0.9rem; color: #7f8c8d; margin-bottom: 0.5rem;">ìš”ì•½</div>
            <div id="blog-excerpt" style="margin-bottom: 1rem;"></div>

            <div style="font-size: 0.9rem; color: #7f8c8d; margin-bottom: 0.5rem;">í‚¤ì›Œë“œ</div>
            <div id="blog-keywords"></div>
        </div>

        <div style="margin-top: 1.5rem; border-top: 1px solid #ecf0f1; padding-top: 1.5rem;">
            <div style="font-size: 0.9rem; color: #7f8c8d; margin-bottom: 0.5rem;">ë³¸ë¬¸</div>
            <div id="blog-content" style="line-height: 1.8; white-space: pre-wrap; word-wrap: break-word;"></div>
        </div>
    </div>
</div>

<!-- ì„±ê²½ ì¥ ëª¨ë‹¬ -->
<div id="bibleModal" style="display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 50; overflow-y: auto; padding: 1rem;">
    <div style="max-width: 56rem; margin: 2rem auto; background: white; border-radius: 0.5rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
        <!-- ëª¨ë‹¬ í—¤ë” -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
            <h3 id="modalTitle" style="font-size: 1.5rem; font-weight: bold; color: #1f2937; margin: 0;"></h3>
            <button onclick="closeBibleModal()" style="color: #6b7280; hover:color: #111827; font-size: 1.5rem; background: none; border: none; cursor: pointer; padding: 0.25rem;">&times;</button>
        </div>

        <!-- ëª¨ë‹¬ ë³¸ë¬¸ -->
        <div style="padding: 1.5rem; max-height: calc(90vh - 8rem); overflow-y: auto;">
            <!-- ì£¼ì œ íƒœê·¸ -->
            <div id="modalThemes" style="margin-bottom: 1rem;"></div>

            <!-- í•´ì„ ì •ë³´ -->
            <div id="modalCommentary" style="margin-bottom: 1.5rem;"></div>

            <!-- êµ¬ì ˆ ëª©ë¡ -->
            <div id="modalVerses"></div>
        </div>
    </div>
</div>

<script>
    const blogId = {{ .id }};
    let currentBlog = null;

    async function loadBlog() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';
        document.getElementById('blog-detail').style.display = 'none';

        try {
            const response = await fetch('/api/blogs/' + blogId);
            const blog = await response.json();

            if (!response.ok) {
                throw new Error(blog.error || 'ë¸”ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨');
            }

            currentBlog = blog;
            renderBlog(blog);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('blog-detail').style.display = 'block';
        } catch (error) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = error.message;
            document.getElementById('error').style.display = 'block';
        }
    }

    function renderBlog(blog) {
        document.getElementById('blog-title').textContent = blog.title;
        document.getElementById('blog-slug').textContent = blog.slug;
        document.getElementById('blog-views').textContent = blog.view_count;
        document.getElementById('blog-excerpt').textContent = blog.excerpt;
        document.getElementById('blog-keywords').textContent = blog.keywords;

        // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ (ê°„ë‹¨í•œ ë³€í™˜)
        const contentEl = document.getElementById('blog-content');
        contentEl.innerHTML = convertMarkdownToHTML(blog.content);

        // ì„±ê²½ ë§í¬ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        addBibleLinkHandlers();

        const btnPublish = document.getElementById('btn-publish');
        if (blog.is_published) {
            btnPublish.textContent = 'ë°œí–‰ ì·¨ì†Œ';
            btnPublish.className = 'btn btn-danger';
        } else {
            btnPublish.textContent = 'ë°œí–‰';
            btnPublish.className = 'btn btn-success';
        }

        document.getElementById('score-theological').textContent = blog.theological_accuracy !== null ? blog.theological_accuracy.toFixed(1) : '-';
        document.getElementById('score-structure').textContent = blog.content_structure !== null ? blog.content_structure.toFixed(1) : '-';
        document.getElementById('score-engagement').textContent = blog.engagement !== null ? blog.engagement.toFixed(1) : '-';
        document.getElementById('score-technical').textContent = blog.technical_quality !== null ? blog.technical_quality.toFixed(1) : '-';
        document.getElementById('score-seo').textContent = blog.seo_optimization !== null ? blog.seo_optimization.toFixed(1) : '-';

        if (blog.total_score !== null) {
            const totalScore = blog.total_score.toFixed(1);
            document.getElementById('score-total').textContent = totalScore;

            const scoreEl = document.getElementById('score-total');
            if (totalScore >= 8) scoreEl.style.color = '#27ae60';
            else if (totalScore >= 6) scoreEl.style.color = '#f39c12';
            else scoreEl.style.color = '#e74c3c';
        } else {
            document.getElementById('score-total').textContent = '-';
        }

        if (blog.quality_feedback) {
            try {
                const feedback = typeof blog.quality_feedback === 'string'
                    ? JSON.parse(blog.quality_feedback)
                    : blog.quality_feedback;

                let feedbackHtml = '';
                if (feedback.strengths && feedback.strengths.length > 0) {
                    feedbackHtml += 'âœ… ì¥ì :\n';
                    feedback.strengths.forEach(s => feedbackHtml += 'â€¢ ' + s + '\n');
                    feedbackHtml += '\n';
                }
                if (feedback.improvements && feedback.improvements.length > 0) {
                    feedbackHtml += 'ğŸ“ ê°œì„ ì‚¬í•­:\n';
                    feedback.improvements.forEach(i => feedbackHtml += 'â€¢ ' + i + '\n');
                    feedbackHtml += '\n';
                }
                if (feedback.critical_issues && feedback.critical_issues.length > 0) {
                    feedbackHtml += 'ğŸš¨ ì¹˜ëª…ì  ë¬¸ì œ:\n';
                    feedback.critical_issues.forEach(c => feedbackHtml += 'â€¢ ' + c + '\n');
                }

                document.getElementById('quality-feedback').textContent = feedbackHtml || 'í‰ê°€ í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤';
            } catch (e) {
                document.getElementById('quality-feedback').textContent = blog.quality_feedback;
            }
        } else {
            document.getElementById('quality-feedback').textContent = 'í‰ê°€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤';
        }

        document.getElementById('evaluation-date').textContent = blog.evaluation_date
            ? new Date(blog.evaluation_date).toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            })
            : '-';
        document.getElementById('evaluator').textContent = blog.evaluator || '-';

        // ì¬ìƒì„± ë²„íŠ¼ì€ í•­ìƒ í‘œì‹œ (í†µê³¼í•œ ì»¨í…ì¸ ë„ ì¬ìƒì„± ê°€ëŠ¥)
        const btnRegenerate = document.getElementById('btn-regenerate');
        btnRegenerate.style.display = 'inline-block';
    }

    async function togglePublish() {
        if (!currentBlog) return;

        const newStatus = !currentBlog.is_published;
        const confirmMsg = newStatus ? 'ì´ ë¸”ë¡œê·¸ë¥¼ ë°œí–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ì´ ë¸”ë¡œê·¸ì˜ ë°œí–‰ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';

        if (!confirm(confirmMsg)) return;

        try {
            const response = await fetch('/api/blogs/' + blogId + '/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_published: newStatus })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'ë°œí–‰ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
            }

            showSuccess(result.message);
            loadBlog();
        } catch (error) {
            showError(error.message);
        }
    }

    function showSuccess(message) {
        const successEl = document.getElementById('success');
        successEl.textContent = message;
        successEl.style.display = 'block';
        setTimeout(() => {
            successEl.style.display = 'none';
        }, 3000);
    }

    function showError(message) {
        const errorEl = document.getElementById('error');
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        setTimeout(() => {
            errorEl.style.display = 'none';
        }, 5000);
    }

    let evaluationHistory = [];
    let historyVisible = false;

    async function evaluateBlog() {
        if (!confirm('ì´ ë¸”ë¡œê·¸ë¥¼ Gemini APIë¡œ ì¬í‰ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní‰ê°€ì— 5-10ì´ˆ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.')) {
            return;
        }

        const btn = document.getElementById('btn-evaluate');
        const originalText = btn.textContent;
        btn.textContent = 'í‰ê°€ ì¤‘...';
        btn.disabled = true;

        document.getElementById('error').style.display = 'none';
        document.getElementById('success').style.display = 'none';

        try {
            const response = await fetch('/api/blogs/' + blogId + '/gemini-evaluate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'í‰ê°€ ì‹¤íŒ¨');
            }

            let message = 'í‰ê°€ ì™„ë£Œ!\n\n';
            message += 'ì´ì : ' + result.evaluation.total_score.toFixed(1) + '/10\n';
            message += 'ê¶Œì¥ì‚¬í•­: ' + result.evaluation.recommendation + '\n';

            if (result.auto_published) {
                message += '\nâœ… í’ˆì§ˆ ê¸°ì¤€ì„ í†µê³¼í•˜ì—¬ ìë™ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!';
            } else if (result.can_publish) {
                message += '\nâœ… ë°œí–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤';
            } else {
                message += '\nâ³ ë°œí–‰ ë¶ˆê°€: ' + result.reason;
            }

            document.getElementById('success').textContent = message;
            document.getElementById('success').style.display = 'block';

            // í‰ê°€ ì´ë ¥ ìƒˆë¡œê³ ì¹¨
            evaluationHistory = [];
            if (historyVisible) {
                loadEvaluationHistory();
            }

            // ë¸”ë¡œê·¸ ì •ë³´ ìƒˆë¡œê³ ì¹¨
            loadBlog();
        } catch (error) {
            document.getElementById('error').textContent = 'í‰ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
            document.getElementById('error').style.display = 'block';
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    function toggleRegenerateForm() {
        const form = document.getElementById('regenerate-form');
        if (form.style.display === 'none') {
            form.style.display = 'block';
            // í¬ì»¤ìŠ¤ ì„¤ì •
            document.getElementById('custom-feedback').focus();
        } else {
            form.style.display = 'none';
            // ì…ë ¥ ë‚´ìš© ì´ˆê¸°í™”
            document.getElementById('custom-feedback').value = '';
        }
    }

    async function executeRegenerate() {
        if (!currentBlog) return;

        const customFeedback = document.getElementById('custom-feedback').value.trim();

        const confirmMsg = 'í‰ê°€ í”¼ë“œë°±ì„ ê¸°ë°˜ìœ¼ë¡œ ë¸”ë¡œê·¸ë¥¼ ì¬ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
            'í˜„ì¬ ì ìˆ˜: ' + (currentBlog.total_score ? currentBlog.total_score.toFixed(1) : '-') + '/10\n' +
            (customFeedback ? 'ì¶”ê°€ í”¼ë“œë°±: ' + customFeedback.substring(0, 50) + (customFeedback.length > 50 ? '...' : '') + '\n' : '') +
            'ì¬ìƒì„±ì— 15-30ì´ˆ ì •ë„ ì†Œìš”ë˜ë©°, ê¸°ì¡´ ë‚´ìš©ì€ ë®ì–´ì¨ì§‘ë‹ˆë‹¤.\n\n' +
            'ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';

        if (!confirm(confirmMsg)) return;

        // í¼ ìˆ¨ê¸°ê¸°
        document.getElementById('regenerate-form').style.display = 'none';

        const btn = document.getElementById('btn-regenerate');
        const originalText = btn.textContent;
        btn.textContent = 'ì¬ìƒì„± ì¤‘...';
        btn.disabled = true;

        document.getElementById('error').style.display = 'none';
        document.getElementById('success').style.display = 'none';

        try {
            const response = await fetch('/api/blogs/' + blogId + '/regenerate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    custom_feedback: customFeedback
                })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'ì¬ìƒì„± ì‹¤íŒ¨');
            }

            let message = 'ğŸ‰ ë¸”ë¡œê·¸ê°€ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n';
            if (customFeedback) {
                message += 'ğŸ“ ì‚¬ìš©ì í”¼ë“œë°± ë°˜ì˜ë¨\n\n';
            }
            message += 'ì´ì „ ì ìˆ˜: ' + result.old_score.toFixed(1) + '/10\n';
            message += 'ìƒˆ ì ìˆ˜: ' + result.new_score.toFixed(1) + '/10\n';

            if (result.improved) {
                message += 'âœ… ì ìˆ˜ê°€ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤! (+' + (result.new_score - result.old_score).toFixed(1) + ')\n';
            } else {
                message += 'âš ï¸ ì ìˆ˜ ë³€í™”: ' + (result.new_score - result.old_score).toFixed(1) + '\n';
            }

            if (result.can_publish) {
                message += '\nâœ… ë°œí–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤';
            } else {
                message += '\nâ³ ë°œí–‰ ë¶ˆê°€: ' + result.reason;
            }

            document.getElementById('success').textContent = message;
            document.getElementById('success').style.display = 'block';

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('custom-feedback').value = '';

            // í‰ê°€ ì´ë ¥ ìƒˆë¡œê³ ì¹¨
            evaluationHistory = [];
            if (historyVisible) {
                loadEvaluationHistory();
            }

            // ë¸”ë¡œê·¸ ì •ë³´ ìƒˆë¡œê³ ì¹¨
            loadBlog();
        } catch (error) {
            document.getElementById('error').textContent = 'ì¬ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
            document.getElementById('error').style.display = 'block';
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    async function loadEvaluationHistory() {
        try {
            const response = await fetch('/api/blogs/' + blogId + '/evaluation-history');
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'í‰ê°€ ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨');
            }

            evaluationHistory = data.history || [];
            renderHistory();
        } catch (error) {
            console.error('í‰ê°€ ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    function toggleHistory() {
        historyVisible = !historyVisible;
        const historySection = document.getElementById('history-section');
        const btn = document.getElementById('btn-toggle-history');

        if (historyVisible) {
            historySection.style.display = 'block';
            btn.textContent = 'í‰ê°€ ì´ë ¥ ìˆ¨ê¸°ê¸°';
            if (evaluationHistory.length === 0) {
                loadEvaluationHistory();
            }
        } else {
            historySection.style.display = 'none';
            btn.textContent = 'í‰ê°€ ì´ë ¥ ë³´ê¸°';
        }
    }

    function renderHistory() {
        const container = document.getElementById('history-list');

        if (evaluationHistory.length === 0) {
            container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #7f8c8d;">í‰ê°€ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }

        let html = '';
        evaluationHistory.forEach((h, index) => {
            const date = new Date(h.evaluated_at).toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            const totalScore = h.total_score.toFixed(1);

            let scoreColor = '#e74c3c';
            if (totalScore >= 8) scoreColor = '#27ae60';
            else if (totalScore >= 6) scoreColor = '#f39c12';

            html += '<div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">';
            html += '<div style="font-weight: bold; color: #2c3e50;">#' + (index + 1) + ' - ' + date + '</div>';
            html += '<div style="font-size: 1.1rem; font-weight: bold; color: ' + scoreColor + ';">' + totalScore + '/10</div>';
            html += '</div>';

            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">';
            html += '<div style="font-size: 0.85rem;"><span style="color: #7f8c8d;">ì‹ í•™ì :</span> ' + h.theological_accuracy.toFixed(1) + '</div>';
            html += '<div style="font-size: 0.85rem;"><span style="color: #7f8c8d;">êµ¬ì¡°:</span> ' + h.content_structure.toFixed(1) + '</div>';
            html += '<div style="font-size: 0.85rem;"><span style="color: #7f8c8d;">ì°¸ì—¬ë„:</span> ' + h.engagement.toFixed(1) + '</div>';
            html += '<div style="font-size: 0.85rem;"><span style="color: #7f8c8d;">ê¸°ìˆ :</span> ' + h.technical_quality.toFixed(1) + '</div>';
            html += '<div style="font-size: 0.85rem;"><span style="color: #7f8c8d;">SEO:</span> ' + h.seo_optimization.toFixed(1) + '</div>';
            html += '</div>';

            if (h.quality_feedback) {
                try {
                    const feedback = typeof h.quality_feedback === 'string'
                        ? JSON.parse(h.quality_feedback)
                        : h.quality_feedback;

                    if (feedback.strengths && feedback.strengths.length > 0) {
                        html += '<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #27ae60;">âœ… ' + feedback.strengths[0] + '</div>';
                    }
                    if (feedback.critical_issues && feedback.critical_issues.length > 0) {
                        html += '<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #e74c3c;">ğŸš¨ ' + feedback.critical_issues[0] + '</div>';
                    }
                } catch (e) {
                    // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
                }
            }

            html += '<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #7f8c8d;">í‰ê°€ì: ' + h.evaluator + '</div>';
            html += '</div>';
        });

        container.innerHTML = html;
    }

    // ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
    function convertMarkdownToHTML(markdown) {
        let html = markdown;

        // ì„±ê²½ ë§í¬ë¥¼ ëª¨ë‹¬ íŠ¸ë¦¬ê±°ë¡œ ë³€í™˜
        html = html.replace(/\[([^\]]+)\]\((\/api\/bible\/chapters\/([^\/]+)\/(\d+))\)/g, function(match, text, url, bookId, chapter) {
            return `<a href="#" data-book-id="${bookId}" data-chapter="${chapter}" class="bible-link" style="color: #3498db; text-decoration: underline; cursor: pointer;">${text}</a>`;
        });

        // ì¼ë°˜ ë§í¬ ë³€í™˜ (ì„±ê²½ ë§í¬ê°€ ì•„ë‹Œ ê²½ìš°)
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" style="color: #3498db; text-decoration: underline;" target="_blank">$1</a>');

        // êµµì€ ê¸€ì”¨ **text**
        html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

        // ì œëª© ë³€í™˜ (# H1, ## H2, ### H3)
        html = html.replace(/^### (.+)$/gm, '<h3 style="font-size: 1.25rem; font-weight: bold; margin: 1.5rem 0 0.75rem; color: #2c3e50;">$1</h3>');
        html = html.replace(/^## (.+)$/gm, '<h2 style="font-size: 1.5rem; font-weight: bold; margin: 2rem 0 1rem; color: #2c3e50;">$1</h2>');
        html = html.replace(/^# (.+)$/gm, '<h1 style="font-size: 1.75rem; font-weight: bold; margin: 2rem 0 1rem; color: #2c3e50;">$1</h1>');

        // blockquote ë³€í™˜ > text
        html = html.replace(/^> (.+)$/gm, '<blockquote style="border-left: 4px solid #3498db; padding-left: 1rem; margin: 1rem 0; color: #555;">$1</blockquote>');

        // ì¤„ë°”ê¿ˆ ë³€í™˜
        html = html.replace(/\n/g, '<br>');

        return html;
    }

    // ì„±ê²½ ë§í¬ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    function addBibleLinkHandlers() {
        const contentEl = document.getElementById('blog-content');
        const links = contentEl.querySelectorAll('a.bible-link');

        links.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const bookId = this.getAttribute('data-book-id');
                const chapter = parseInt(this.getAttribute('data-chapter'));
                if (bookId && chapter) {
                    openBibleModal(bookId, chapter);
                }
            });
        });
    }

    // ì„±ê²½ ëª¨ë‹¬ ì—´ê¸°
    async function openBibleModal(bookId, chapter) {
        try {
            const response = await fetch(`http://localhost:8080/api/bible/chapters/${bookId}/${chapter}`);
            if (!response.ok) {
                throw new Error('ì„±ê²½ ì¥ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }

            const data = await response.json();
            showBibleModal(data);
        } catch (error) {
            console.error('ì„±ê²½ ì¥ ë¡œë”© ì‹¤íŒ¨:', error);
            alert('ì„±ê²½ ì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }

    // ì„±ê²½ ëª¨ë‹¬ í‘œì‹œ
    function showBibleModal(data) {
        const modal = document.getElementById('bibleModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalThemes = document.getElementById('modalThemes');
        const modalCommentary = document.getElementById('modalCommentary');
        const modalVerses = document.getElementById('modalVerses');

        // ì œëª© ì„¤ì •
        modalTitle.textContent = `${data.book_name} ${data.chapter}ì¥`;

        // ì£¼ì œ íƒœê·¸ í‘œì‹œ
        if (data.commentary && data.commentary.themes) {
            try {
                const themes = JSON.parse(data.commentary.themes);
                modalThemes.innerHTML = themes.map(theme => `
                    <span style="display: inline-block; padding: 0.25rem 0.75rem; margin: 0.25rem; background: #dbeafe; color: #1e40af; border-radius: 9999px; font-size: 0.875rem; font-weight: 500;">${theme}</span>
                `).join('');
            } catch (e) {
                modalThemes.innerHTML = '';
            }
        } else {
            modalThemes.innerHTML = '';
        }

        // í•´ì„ ì •ë³´ í‘œì‹œ
        if (data.commentary && (data.commentary.title || data.commentary.summary)) {
            const commentary = data.commentary;
            let commentaryHtml = '<div style="background: linear-gradient(to right, #fef3c7, #fef9c3); padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid #f59e0b; margin-bottom: 1.5rem;">';

            if (commentary.title) {
                commentaryHtml += `<h4 style="font-size: 1.25rem; font-weight: bold; color: #92400e; margin-bottom: 0.75rem;">ğŸ“– ${commentary.title}</h4>`;
            }

            if (commentary.summary) {
                commentaryHtml += `<p style="color: #78350f; line-height: 1.6; margin-bottom: 0.75rem;">${commentary.summary}</p>`;
            }

            if (commentary.application) {
                commentaryHtml += `<div style="background: rgba(255,255,255,0.7); padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.75rem;">`;
                commentaryHtml += `<div style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">ğŸ’¡ ì ìš©</div>`;
                commentaryHtml += `<p style="color: #78350f; line-height: 1.6;">${commentary.application}</p>`;
                commentaryHtml += `</div>`;
            }

            commentaryHtml += '</div>';
            modalCommentary.innerHTML = commentaryHtml;
        } else {
            modalCommentary.innerHTML = '';
        }

        // êµ¬ì ˆ ëª©ë¡ í‘œì‹œ
        let versesHtml = '';
        data.verses.forEach(verse => {
            versesHtml += `
                <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: #f9fafb; border-radius: 0.5rem; display: flex; gap: 1rem;">
                    <div style="font-weight: bold; color: #6b7280; min-width: 2rem; text-align: right;">${verse.verse}</div>
                    <div style="flex: 1; color: #374151; line-height: 1.6;">${verse.content}</div>
                    <button onclick="copyVerse(${verse.verse}, '${verse.content.replace(/'/g, "\\'")}', '${data.book_name}', ${data.chapter})" style="background: none; border: none; cursor: pointer; color: #6b7280; font-size: 1.25rem; padding: 0.25rem;" title="ë³µì‚¬">ğŸ“‹</button>
                </div>
            `;
        });
        modalVerses.innerHTML = versesHtml;

        // ëª¨ë‹¬ í‘œì‹œ
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    // ì„±ê²½ ëª¨ë‹¬ ë‹«ê¸°
    function closeBibleModal() {
        const modal = document.getElementById('bibleModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeBibleModal();
        }
    });

    // ë°°ê²½ í´ë¦­ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.getElementById('bibleModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeBibleModal();
        }
    });

    // êµ¬ì ˆ ë³µì‚¬
    function copyVerse(verseNum, content, bookName, chapter) {
        const text = `${bookName} ${chapter}:${verseNum} - ${content}`;
        navigator.clipboard.writeText(text).then(() => {
            showSuccess(`${bookName} ${chapter}:${verseNum} ë³µì‚¬ ì™„ë£Œ!`);
        }).catch(err => {
            console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        });
    }

    loadBlog();
</script>
    </div>
</body>
</html>
