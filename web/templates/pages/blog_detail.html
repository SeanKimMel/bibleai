{{define "blog_detail.html"}}
{{template "base.html" .}}
{{end}}

{{define "blog-detail-content"}}
<!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
<div class="mb-6">
    <a href="/blog" class="inline-flex items-center text-teal-600 hover:text-teal-700 transition-colors">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    </a>
</div>

<!-- ë¸”ë¡œê·¸ ìƒì„¸ ë‚´ìš© -->
<article class="bg-white rounded-3xl shadow-lg overflow-hidden">
    <!-- í—¤ë” -->
    <div class="bg-gradient-to-r from-teal-500 to-teal-600 p-8">
        <h1 class="text-3xl font-bold text-white mb-4">{{.Post.Title}}</h1>
        <div class="flex items-center justify-between text-white/90 text-sm">
            <span>{{.FormattedDate}}</span>
            <div class="flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                <span>ì¡°íšŒ {{.Post.ViewCount}}íšŒ</span>
            </div>
        </div>
    </div>

    <!-- í‚¤ì›Œë“œ -->
    {{if .Post.Keywords}}
    <div class="px-8 py-4 bg-teal-50 border-b border-teal-100">
        <div class="flex flex-wrap gap-2">
            {{range .KeywordList}}
            <span class="px-3 py-1 bg-white text-teal-700 rounded-full text-sm border border-teal-200">#{{.}}</span>
            {{end}}
        </div>
    </div>
    {{end}}

    <!-- ë³¸ë¬¸ -->
    <div class="p-8 md:p-12">
        <div class="prose prose-lg max-w-none markdown-content">
            {{.Post.ContentHTML}}
        </div>
    </div>

    <!-- ê³µìœ í•˜ê¸° ì„¹ì…˜ -->
    <div class="px-8 pb-8 md:px-12 md:pb-12">
        <div class="border-t pt-8">
            <div class="text-center mb-4">
                <h3 class="text-lg font-semibold text-gray-700">ì´ ê¸€ì´ ë„ì›€ì´ ë˜ì…¨ë‚˜ìš”?</h3>
                <p class="text-sm text-gray-500 mt-1">ì¢‹ì€ ë§ì”€ì„ ë” ë§ì€ ë¶„ë“¤ê³¼ ë‚˜ëˆ„ì–´ë³´ì„¸ìš”!</p>
            </div>

            <!-- ê³µìœ  ë²„íŠ¼ë“¤ -->
            <div class="flex flex-wrap justify-center gap-3">
                <!-- ë§í¬ ë³µì‚¬ (ì£¼ìš” ë²„íŠ¼) -->
                <button onclick="copyLink()" class="inline-flex items-center px-5 py-2.5 bg-teal-600 hover:bg-teal-700 text-white rounded-lg transition-colors duration-200 shadow-sm hover:shadow-md font-medium">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    ë§í¬ ë³µì‚¬
                </button>

                <!-- í˜ì´ìŠ¤ë¶ ê³µìœ  -->
                <button onclick="shareFacebook()" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200 shadow-sm hover:shadow-md">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/>
                    </svg>
                    í˜ì´ìŠ¤ë¶
                </button>

                <!-- X (íŠ¸ìœ„í„°) ê³µìœ  -->
                <button onclick="shareTwitter()" class="inline-flex items-center px-4 py-2 bg-black hover:bg-gray-800 text-white rounded-lg transition-colors duration-200 shadow-sm hover:shadow-md">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                    X
                </button>
            </div>

            <!-- ë³µì‚¬ ì™„ë£Œ ë©”ì‹œì§€ -->
            <div id="copyMessage" class="hidden mt-4 text-center text-sm text-green-600 font-medium">
                âœ… ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="px-8 py-6 bg-gray-50 border-t border-gray-200">
        <a href="/blog" class="inline-flex items-center text-teal-600 hover:text-teal-700 font-medium transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </a>
    </div>
</article>

<!-- ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ -->
<style>
.markdown-content h1 {
    font-size: 2rem;
    font-weight: bold;
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: #0f766e;
}

.markdown-content h2 {
    font-size: 1.5rem;
    font-weight: bold;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: #14b8a6;
}

.markdown-content h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 1.25rem;
    margin-bottom: 0.5rem;
}

.markdown-content p {
    margin-bottom: 1rem;
    line-height: 1.8;
}

.markdown-content blockquote {
    border-left: 4px solid #14b8a6;
    padding-left: 1rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: #374151;
    background: #f0fdfa;
    padding: 1rem;
    border-radius: 0.5rem;
}

.markdown-content ul, .markdown-content ol {
    margin-left: 1.5rem;
    margin-bottom: 1rem;
}

.markdown-content li {
    margin-bottom: 0.5rem;
    line-height: 1.6;
}

.markdown-content strong {
    font-weight: 700;
    color: #0f766e;
}

.markdown-content code {
    background: #f3f4f6;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.9em;
}

.markdown-content a {
    color: #0d9488;
    text-decoration: underline;
}

.markdown-content a:hover {
    color: #0f766e;
}

/* ë°˜ì‘í˜• iframe (YouTube ì„ë² ë””ë“œ ë“±) */
.markdown-content iframe {
    max-width: 100%;
    width: 100%;
    height: auto;
    aspect-ratio: 16 / 9;
    border-radius: 0.5rem;
    margin: 1.5rem 0;
}

/* ëª¨ë°”ì¼ ìµœì í™” */
@media (max-width: 768px) {
    .markdown-content iframe {
        margin: 1rem 0;
    }
}
</style>

<!-- ì„±ê²½ ì¥ ëª¨ë‹¬ -->
<div id="bibleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto p-4">
    <div class="max-w-4xl mx-auto my-8 bg-white rounded-2xl shadow-2xl">
        <!-- ëª¨ë‹¬ í—¤ë” -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-900"></h3>
            <button onclick="closeBibleModal()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
        </div>

        <!-- ëª¨ë‹¬ ë³¸ë¬¸ -->
        <div class="p-6 max-h-[calc(90vh-8rem)] overflow-y-auto">
            <!-- ì£¼ì œ íƒœê·¸ -->
            <div id="modalThemes" class="mb-4"></div>

            <!-- í•´ì„ ì •ë³´ -->
            <div id="modalCommentary" class="mb-6"></div>

            <!-- êµ¬ì ˆ ëª©ë¡ -->
            <div id="modalVerses"></div>
        </div>
    </div>
</div>

<!-- ê³µìœ  ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
// í˜ì´ì§€ ì •ë³´
const pageTitle = "{{.Post.Title}}";
const pageUrl = window.location.href;

// ì„±ê²½ ë§í¬ ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
    // ëª¨ë“  ì„±ê²½ ë§í¬ë¥¼ ì°¾ì•„ì„œ ëª¨ë‹¬ë¡œ ì²˜ë¦¬
    const bibleLinks = document.querySelectorAll('.markdown-content a[href^="/api/bible/chapters/"]');

    bibleLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('href');
            // /api/bible/chapters/ph/4 -> ph, 4 ì¶”ì¶œ
            const match = href.match(/\/api\/bible\/chapters\/([^\/]+)\/(\d+)/);
            if (match) {
                const bookId = match[1];
                const chapter = parseInt(match[2]);
                openBibleModal(bookId, chapter);
            }
        });
    });
});

// ì„±ê²½ ëª¨ë‹¬ ì—´ê¸°
async function openBibleModal(bookId, chapter) {
    try {
        const response = await fetch(`/api/bible/chapters/${bookId}/${chapter}`);
        if (!response.ok) {
            throw new Error('ì„±ê²½ ì¥ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }

        const data = await response.json();
        showBibleModal(data);
    } catch (error) {
        console.error('ì„±ê²½ ì¥ ë¡œë”© ì‹¤íŒ¨:', error);
        alert('ì„±ê²½ ì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// ì„±ê²½ ëª¨ë‹¬ í‘œì‹œ
function showBibleModal(data) {
    const modal = document.getElementById('bibleModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalThemes = document.getElementById('modalThemes');
    const modalCommentary = document.getElementById('modalCommentary');
    const modalVerses = document.getElementById('modalVerses');

    // ì œëª© ì„¤ì •
    modalTitle.textContent = `${data.book_name} ${data.chapter}ì¥`;

    // ì£¼ì œ íƒœê·¸ í‘œì‹œ
    if (data.commentary && data.commentary.themes) {
        try {
            const themes = JSON.parse(data.commentary.themes);
            modalThemes.innerHTML = themes.map(theme => `
                <span class="inline-block px-3 py-1 m-1 bg-teal-100 text-teal-800 rounded-full text-sm font-medium">${theme}</span>
            `).join('');
        } catch (e) {
            modalThemes.innerHTML = '';
        }
    } else {
        modalThemes.innerHTML = '';
    }

    // í•´ì„ ì •ë³´ í‘œì‹œ
    if (data.commentary && (data.commentary.title || data.commentary.summary)) {
        const commentary = data.commentary;
        let commentaryHtml = '<div class="bg-gradient-to-r from-amber-50 to-yellow-50 p-6 rounded-xl border-l-4 border-amber-400 mb-6">';

        if (commentary.title) {
            commentaryHtml += `<h4 class="text-xl font-bold text-amber-900 mb-3">ğŸ“– ${commentary.title}</h4>`;
        }

        if (commentary.summary) {
            commentaryHtml += `<p class="text-amber-900 leading-relaxed mb-3">${commentary.summary}</p>`;
        }

        if (commentary.application) {
            commentaryHtml += `<div class="bg-white bg-opacity-70 p-4 rounded-lg mt-3">`;
            commentaryHtml += `<div class="font-semibold text-amber-900 mb-2">ğŸ’¡ ì ìš©</div>`;
            commentaryHtml += `<p class="text-amber-900 leading-relaxed">${commentary.application}</p>`;
            commentaryHtml += `</div>`;
        }

        commentaryHtml += '</div>';
        modalCommentary.innerHTML = commentaryHtml;
    } else {
        modalCommentary.innerHTML = '';
    }

    // êµ¬ì ˆ ëª©ë¡ í‘œì‹œ
    let versesHtml = '';
    data.verses.forEach(verse => {
        versesHtml += `
            <div class="flex gap-4 p-3 mb-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="font-bold text-gray-500 min-w-[2rem] text-right">${verse.verse}</div>
                <div class="flex-1 text-gray-700 leading-relaxed">${verse.content}</div>
                <button onclick="copyVerse(${verse.verse}, '${verse.content.replace(/'/g, "\\'")}', '${data.book_name}', ${data.chapter})"
                        class="text-gray-400 hover:text-teal-600 text-xl" title="ë³µì‚¬">ğŸ“‹</button>
            </div>
        `;
    });
    modalVerses.innerHTML = versesHtml;

    // ëª¨ë‹¬ í‘œì‹œ
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

// ì„±ê²½ ëª¨ë‹¬ ë‹«ê¸°
function closeBibleModal() {
    const modal = document.getElementById('bibleModal');
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeBibleModal();
    }
});

// ë°°ê²½ í´ë¦­ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.getElementById('bibleModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeBibleModal();
    }
});

// êµ¬ì ˆ ë³µì‚¬
function copyVerse(verseNum, content, bookName, chapter) {
    const text = `${bookName} ${chapter}:${verseNum} - ${content}`;

    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification(`${bookName} ${chapter}:${verseNum} ë³µì‚¬ ì™„ë£Œ!`);
        });
    } else {
        // Fallback
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.top = "0";
        textArea.style.left = "0";
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showNotification(`${bookName} ${chapter}:${verseNum} ë³µì‚¬ ì™„ë£Œ!`);
        } catch (err) {
            console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        }
        document.body.removeChild(textArea);
    }
}

// ì•Œë¦¼ í‘œì‹œ
function showNotification(message) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.className = 'fixed bottom-4 right-4 bg-teal-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// í˜ì´ìŠ¤ë¶ ê³µìœ 
function shareFacebook() {
    const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}`;
    window.open(url, '_blank', 'width=600,height=400');
}

// íŠ¸ìœ„í„°(X) ê³µìœ 
function shareTwitter() {
    const text = `${pageTitle} - ë‚˜í™€ë¡œì˜ˆë°°`;
    const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(pageUrl)}`;
    window.open(url, '_blank', 'width=600,height=400');
}

// ë§í¬ ë³µì‚¬
function copyLink() {
    // Clipboard API ì§€ì› ì—¬ë¶€ í™•ì¸
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(pageUrl).then(() => {
            showCopyMessage();
        }).catch(err => {
            // Clipboard API ì‹¤íŒ¨ì‹œ fallback
            fallbackCopyTextToClipboard(pageUrl);
        });
    } else {
        // Clipboard API ë¯¸ì§€ì›ì‹œ fallback
        fallbackCopyTextToClipboard(pageUrl);
    }
}

// Clipboard API fallback
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.width = "2em";
    textArea.style.height = "2em";
    textArea.style.padding = "0";
    textArea.style.border = "none";
    textArea.style.outline = "none";
    textArea.style.boxShadow = "none";
    textArea.style.background = "transparent";

    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        document.execCommand('copy');
        showCopyMessage();
    } catch (err) {
        console.error('ë§í¬ ë³µì‚¬ ì‹¤íŒ¨:', err);
        alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì£¼ì†Œì°½ì—ì„œ ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
    }

    document.body.removeChild(textArea);
}

// ë³µì‚¬ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
function showCopyMessage() {
    const message = document.getElementById('copyMessage');
    message.classList.remove('hidden');
    setTimeout(() => {
        message.classList.add('hidden');
    }, 3000);
}
</script>
{{end}}
