{{define "blog_detail.html"}}
{{template "base.html" .}}
{{end}}

{{define "blog-detail-content"}}
<!-- 뒤로가기 버튼 -->
<div class="mb-6">
    <a href="/blog" class="inline-flex items-center text-teal-600 hover:text-teal-700 transition-colors">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        목록으로 돌아가기
    </a>
</div>

<!-- 블로그 상세 내용 -->
<article class="bg-white rounded-3xl shadow-lg overflow-hidden">
    <!-- 헤더 -->
    <div class="bg-gradient-to-r from-teal-500 to-teal-600 p-8">
        <h1 class="text-3xl font-bold text-white mb-4">{{.Post.Title}}</h1>
        <div class="flex items-center justify-between text-white/90 text-sm">
            <span>{{.FormattedDate}}</span>
            <div class="flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                <span>조회 {{.Post.ViewCount}}회</span>
            </div>
        </div>
    </div>

    <!-- 키워드 -->
    {{if .Post.Keywords}}
    <div class="px-8 py-4 bg-teal-50 border-b border-teal-100">
        <div class="flex flex-wrap gap-2">
            {{range .KeywordList}}
            <span class="px-3 py-1 bg-white text-teal-700 rounded-full text-sm border border-teal-200">#{{.}}</span>
            {{end}}
        </div>
    </div>
    {{end}}

    <!-- 본문 -->
    <div class="p-8 md:p-12">
        <div class="prose prose-lg max-w-none markdown-content">
            {{.Post.ContentHTML}}
        </div>
    </div>

    <!-- 공유하기 섹션 -->
    <div class="px-8 pb-8 md:px-12 md:pb-12">
        <div class="border-t pt-8">
            <div class="text-center mb-4">
                <h3 class="text-lg font-semibold text-gray-700">이 글이 도움이 되셨나요?</h3>
                <p class="text-sm text-gray-500 mt-1">좋은 말씀을 더 많은 분들과 나누어보세요!</p>
            </div>

            <!-- 공유 버튼들 -->
            <div class="flex flex-wrap justify-center gap-3">
                <!-- 링크 복사 (주요 버튼) -->
                <button onclick="copyLink()" class="inline-flex items-center px-5 py-2.5 bg-teal-600 hover:bg-teal-700 text-white rounded-lg transition-colors duration-200 shadow-sm hover:shadow-md font-medium">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    링크 복사
                </button>

                <!-- 페이스북 공유 -->
                <button onclick="shareFacebook()" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200 shadow-sm hover:shadow-md">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/>
                    </svg>
                    페이스북
                </button>

                <!-- X (트위터) 공유 -->
                <button onclick="shareTwitter()" class="inline-flex items-center px-4 py-2 bg-black hover:bg-gray-800 text-white rounded-lg transition-colors duration-200 shadow-sm hover:shadow-md">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                    X
                </button>
            </div>

            <!-- 복사 완료 메시지 -->
            <div id="copyMessage" class="hidden mt-4 text-center text-sm text-green-600 font-medium">
                ✅ 링크가 복사되었습니다!
            </div>
        </div>
    </div>

    <!-- 하단 네비게이션 -->
    <div class="px-8 py-6 bg-gray-50 border-t border-gray-200">
        <a href="/blog" class="inline-flex items-center text-teal-600 hover:text-teal-700 font-medium transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            목록으로 돌아가기
        </a>
    </div>
</article>

<!-- 마크다운 스타일 -->
<style>
.markdown-content h1 {
    font-size: 2rem;
    font-weight: bold;
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: #0f766e;
}

.markdown-content h2 {
    font-size: 1.5rem;
    font-weight: bold;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: #14b8a6;
}

.markdown-content h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 1.25rem;
    margin-bottom: 0.5rem;
}

.markdown-content p {
    margin-bottom: 1rem;
    line-height: 1.8;
}

.markdown-content blockquote {
    border-left: 4px solid #14b8a6;
    padding-left: 1rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: #374151;
    background: #f0fdfa;
    padding: 1rem;
    border-radius: 0.5rem;
}

.markdown-content ul, .markdown-content ol {
    margin-left: 1.5rem;
    margin-bottom: 1rem;
}

.markdown-content li {
    margin-bottom: 0.5rem;
    line-height: 1.6;
}

.markdown-content strong {
    font-weight: 700;
    color: #0f766e;
}

.markdown-content code {
    background: #f3f4f6;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.9em;
}

.markdown-content a {
    color: #0d9488;
    text-decoration: underline;
}

.markdown-content a:hover {
    color: #0f766e;
}

/* 반응형 iframe (YouTube 임베디드 등) */
.markdown-content iframe {
    max-width: 100%;
    width: 100%;
    height: auto;
    aspect-ratio: 16 / 9;
    border-radius: 0.5rem;
    margin: 1.5rem 0;
}

/* 모바일 최적화 */
@media (max-width: 768px) {
    .markdown-content iframe {
        margin: 1rem 0;
    }
}
</style>

<!-- 성경 장 모달 -->
<div id="bibleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto p-4">
    <div class="max-w-4xl mx-auto my-8 bg-white rounded-2xl shadow-2xl">
        <!-- 모달 헤더 -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-900"></h3>
            <button onclick="closeBibleModal()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
        </div>

        <!-- 모달 본문 -->
        <div class="p-6 max-h-[calc(90vh-8rem)] overflow-y-auto">
            <!-- 주제 태그 -->
            <div id="modalThemes" class="mb-4"></div>

            <!-- 해석 정보 -->
            <div id="modalCommentary" class="mb-6"></div>

            <!-- 구절 목록 -->
            <div id="modalVerses"></div>
        </div>
    </div>
</div>

<!-- 공유 기능 스크립트 -->
<script>
// 페이지 정보
const pageTitle = "{{.Post.Title}}";
const pageUrl = window.location.href;

// 성경 링크 처리
document.addEventListener('DOMContentLoaded', function() {
    // 모든 성경 링크를 찾아서 모달로 처리
    const bibleLinks = document.querySelectorAll('.markdown-content a[href^="/api/bible/chapters/"]');

    bibleLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('href');
            // /api/bible/chapters/ph/4 -> ph, 4 추출
            const match = href.match(/\/api\/bible\/chapters\/([^\/]+)\/(\d+)/);
            if (match) {
                const bookId = match[1];
                const chapter = parseInt(match[2]);
                openBibleModal(bookId, chapter);
            }
        });
    });
});

// 성경 모달 열기
async function openBibleModal(bookId, chapter) {
    try {
        const response = await fetch(`/api/bible/chapters/${bookId}/${chapter}`);
        if (!response.ok) {
            throw new Error('성경 장을 불러올 수 없습니다');
        }

        const data = await response.json();
        showBibleModal(data);
    } catch (error) {
        console.error('성경 장 로딩 실패:', error);
        alert('성경 장을 불러오는데 실패했습니다: ' + error.message);
    }
}

// 성경 모달 표시
function showBibleModal(data) {
    const modal = document.getElementById('bibleModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalThemes = document.getElementById('modalThemes');
    const modalCommentary = document.getElementById('modalCommentary');
    const modalVerses = document.getElementById('modalVerses');

    // 제목 설정
    modalTitle.textContent = `${data.book_name} ${data.chapter}장`;

    // 주제 태그 표시
    if (data.commentary && data.commentary.themes) {
        try {
            const themes = JSON.parse(data.commentary.themes);
            modalThemes.innerHTML = themes.map(theme => `
                <span class="inline-block px-3 py-1 m-1 bg-teal-100 text-teal-800 rounded-full text-sm font-medium">${theme}</span>
            `).join('');
        } catch (e) {
            modalThemes.innerHTML = '';
        }
    } else {
        modalThemes.innerHTML = '';
    }

    // 해석 정보 표시
    if (data.commentary && (data.commentary.title || data.commentary.summary)) {
        const commentary = data.commentary;
        let commentaryHtml = '<div class="bg-gradient-to-r from-amber-50 to-yellow-50 p-6 rounded-xl border-l-4 border-amber-400 mb-6">';

        if (commentary.title) {
            commentaryHtml += `<h4 class="text-xl font-bold text-amber-900 mb-3">📖 ${commentary.title}</h4>`;
        }

        if (commentary.summary) {
            commentaryHtml += `<p class="text-amber-900 leading-relaxed mb-3">${commentary.summary}</p>`;
        }

        if (commentary.application) {
            commentaryHtml += `<div class="bg-white bg-opacity-70 p-4 rounded-lg mt-3">`;
            commentaryHtml += `<div class="font-semibold text-amber-900 mb-2">💡 적용</div>`;
            commentaryHtml += `<p class="text-amber-900 leading-relaxed">${commentary.application}</p>`;
            commentaryHtml += `</div>`;
        }

        commentaryHtml += '</div>';
        modalCommentary.innerHTML = commentaryHtml;
    } else {
        modalCommentary.innerHTML = '';
    }

    // 구절 목록 표시
    let versesHtml = '';
    data.verses.forEach(verse => {
        versesHtml += `
            <div class="flex gap-4 p-3 mb-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="font-bold text-gray-500 min-w-[2rem] text-right">${verse.verse}</div>
                <div class="flex-1 text-gray-700 leading-relaxed">${verse.content}</div>
                <button onclick="copyVerse(${verse.verse}, '${verse.content.replace(/'/g, "\\'")}', '${data.book_name}', ${data.chapter})"
                        class="text-gray-400 hover:text-teal-600 text-xl" title="복사">📋</button>
            </div>
        `;
    });
    modalVerses.innerHTML = versesHtml;

    // 모달 표시
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

// 성경 모달 닫기
function closeBibleModal() {
    const modal = document.getElementById('bibleModal');
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// ESC 키로 모달 닫기
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeBibleModal();
    }
});

// 배경 클릭으로 모달 닫기
document.getElementById('bibleModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeBibleModal();
    }
});

// 구절 복사
function copyVerse(verseNum, content, bookName, chapter) {
    const text = `${bookName} ${chapter}:${verseNum} - ${content}`;

    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification(`${bookName} ${chapter}:${verseNum} 복사 완료!`);
        });
    } else {
        // Fallback
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.top = "0";
        textArea.style.left = "0";
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showNotification(`${bookName} ${chapter}:${verseNum} 복사 완료!`);
        } catch (err) {
            console.error('복사 실패:', err);
        }
        document.body.removeChild(textArea);
    }
}

// 알림 표시
function showNotification(message) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.className = 'fixed bottom-4 right-4 bg-teal-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// 페이스북 공유
function shareFacebook() {
    const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}`;
    window.open(url, '_blank', 'width=600,height=400');
}

// 트위터(X) 공유
function shareTwitter() {
    const text = `${pageTitle} - 하루말씀`;
    const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(pageUrl)}`;
    window.open(url, '_blank', 'width=600,height=400');
}

// 링크 복사
function copyLink() {
    // Clipboard API 지원 여부 확인
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(pageUrl).then(() => {
            showCopyMessage();
        }).catch(err => {
            // Clipboard API 실패시 fallback
            fallbackCopyTextToClipboard(pageUrl);
        });
    } else {
        // Clipboard API 미지원시 fallback
        fallbackCopyTextToClipboard(pageUrl);
    }
}

// Clipboard API fallback
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.width = "2em";
    textArea.style.height = "2em";
    textArea.style.padding = "0";
    textArea.style.border = "none";
    textArea.style.outline = "none";
    textArea.style.boxShadow = "none";
    textArea.style.background = "transparent";

    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        document.execCommand('copy');
        showCopyMessage();
    } catch (err) {
        console.error('링크 복사 실패:', err);
        alert('링크 복사에 실패했습니다. 주소창에서 직접 복사해주세요.');
    }

    document.body.removeChild(textArea);
}

// 복사 완료 메시지 표시
function showCopyMessage() {
    const message = document.getElementById('copyMessage');
    message.classList.remove('hidden');
    setTimeout(() => {
        message.classList.add('hidden');
    }, 3000);
}
</script>
{{end}}
